var background=(function(){"use strict";function w(e){return e==null||typeof e=="function"?{main:e}:e}const y="citizen_one_settings",v={activeProvider:"gemini",providers:{gemini:{key:"gemini",model:"gemini-1.5-flash",enabled:!0},groq:{key:"groq",model:"llama3-8b-8192",enabled:!1},nvidia:{key:"nvidia",baseUrl:"https://integrate.api.nvidia.com/v1",model:"meta/llama-3.1-70b-instruct",enabled:!1},ollama:{key:"ollama",baseUrl:"http://localhost:11434/v1",model:"llama3",enabled:!1}},vaultExists:!1,autoFill:!1,highlightFields:!0};async function k(){return new Promise(e=>{chrome.storage.local.get([y],o=>{o[y]?e({...v,...o[y]}):e(v)})})}function _(e){return`You are CitizenOne, a privacy-first form assistant.
Your task is to analyze a web form and map each form field to the correct data key.

Available data keys from the user's local vault:
${e.map(o=>`  - ${o}`).join(`
`)}

Rules:
1. Respond ONLY with a valid JSON object mapping field IDs to vault keys.
2. Only include fields you can confidently map. Skip fields you are unsure about.
3. Do NOT invent or hallucinate keys not in the vault list above.
4. Format: { "field_id_or_name": "vault_key" }
5. Example: { "first-name": "first_name", "dob": "date_of_birth" }

Output ONLY the JSON object. No explanation, no markdown fences.`}function S(e){const o=e.fields.map(r=>{const n=[`id="${r.id}"`,`type="${r.type}"`,`label="${r.label}"`];return r.placeholder&&n.push(`placeholder="${r.placeholder}"`),r.name&&n.push(`name="${r.name}"`),r.options?.length&&n.push(`options=[${r.options.slice(0,8).join(", ")}]`),r.required&&n.push("required"),r.context&&n.push(`context="${r.context.slice(0,80)}"`),`  { ${n.join(", ")} }`}).join(`,
`);return`Form URL: ${e.url}
Form Title: ${e.title}
Fields:
[
${o}
]

Map these fields to vault keys.`}async function T(e,o,r,n){const i=`https://generativelanguage.googleapis.com/v1beta/models/${o}:generateContent?key=${e}`,a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({system_instruction:{parts:[{text:r}]},contents:[{parts:[{text:n}],role:"user"}],generationConfig:{temperature:.1,maxOutputTokens:1024,responseMimeType:"application/json"}})});if(!a.ok){const s=await a.text();throw new Error(`Gemini error ${a.status}: ${s}`)}return((await a.json())?.candidates?.[0]?.content?.parts?.[0]?.text??"").trim()}async function x(e,o,r,n,i){const a=`${e}/chat/completions`,t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:r,messages:[{role:"system",content:n},{role:"user",content:i}],temperature:.1,max_tokens:1024,response_format:{type:"json_object"}})});if(!t.ok){const u=await t.text();throw new Error(`API error ${t.status}: ${u}`)}return((await t.json())?.choices?.[0]?.message?.content??"").trim()}const E={gemini:{baseUrl:"https://generativelanguage.googleapis.com",model:"gemini-1.5-flash"},groq:{baseUrl:"https://api.groq.com/openai/v1",model:"llama3-8b-8192"},nvidia:{baseUrl:"https://integrate.api.nvidia.com/v1",model:"meta/llama-3.1-70b-instruct"},ollama:{baseUrl:"http://localhost:11434/v1",model:"llama3"}};async function b(e,o,r){const n=E[e.key],i=e.model??n.model,a=e.baseUrl??n.baseUrl,t=_(r),l=S(o);let s;if(e.key==="gemini"){if(!e.apiKey)throw new Error("Gemini API key is required.");s=await T(e.apiKey,i,t,l)}else{if(e.key!=="ollama"&&!e.apiKey)throw new Error(`${e.key} API key is required.`);s=await x(a,e.apiKey??"ollama",i,t,l)}let u;try{const m=s.replace(/```json\n?|```\n?/g,"").trim();u=JSON.parse(m)}catch{throw new Error(`Failed to parse LLM response as JSON. Raw: ${s}`)}const d=new Set(r),p={};for(const[m,c]of Object.entries(u))d.has(c)&&(p[m]=c);return p}async function $(e){return await b(e,{url:"https://test.example",title:"Test Form",fields:[{id:"first_name_field",type:"text",label:"First Name",required:!0}]},["first_name","last_name","email"]),"Connection successful!"}const A=Object.freeze(Object.defineProperty({__proto__:null,analyzeForm:b,testProvider:$},Symbol.toStringTag,{value:"Module"})),O=w(()=>{console.log("[CitizenOne] Background service worker started."),chrome.runtime.onMessage.addListener((e,o,r)=>(P(e,o,r),!0))});async function P(e,o,r){try{switch(e.type){case"ANALYZE_FORM":{const n=e.semanticMap,i=e.vaultKeys,a=await k(),t=a.providers[a.activeProvider],l={key:a.activeProvider,apiKey:t.apiKey,baseUrl:t.baseUrl,model:t.model},s=await b(l,n,i);r({success:!0,data:s});break}case"INJECT_AND_GET_MAP":{const n=o.tab?.id??e.tabId;if(!n){r({success:!1,error:"No tab ID provided."});return}const a=(await chrome.scripting.executeScript({target:{tabId:n},func:N}))?.[0]?.result;if(!a){r({success:!1,error:"Failed to extract semantic map."});return}r({success:!0,data:a});break}case"TEST_PROVIDER":{const{providerKey:n,apiKey:i,baseUrl:a,model:t}=e,{testProvider:l}=await Promise.resolve().then(()=>A),s=await l({key:n,apiKey:i,baseUrl:a,model:t});r({success:!0,data:s});break}default:r({success:!1,error:`Unknown message type: ${e.type}`})}}catch(n){const i=n instanceof Error?n.message:String(n);console.error("[CitizenOne] Background error:",i),r({success:!1,error:i})}}function N(){function o(t){const l=t.getAttribute("aria-label");if(l)return l.trim();const s=t.getAttribute("aria-labelledby");if(s){const c=document.getElementById(s);if(c)return(c.textContent??"").trim()}const u=t.id;if(u){const c=document.querySelector(`label[for="${CSS.escape(u)}"]`);if(c)return(c.textContent??"").trim()}const d=t.closest("label");if(d){const c=d.cloneNode(!0);c.querySelectorAll("input,select,textarea").forEach(j=>j.remove());const f=(c.textContent??"").trim();if(f)return f}const p=t.placeholder;if(p)return p.trim();const m=t.getAttribute("name");return m?m.replace(/[_-]/g," ").trim():""}const n=Array.from(document.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="image"]), select, textarea')),i=[];let a=0;for(const t of n){if(!t.offsetParent)continue;if(a>=2048)break;const l=t.id||t.getAttribute("name")||`field_${i.length}`,s=t.tagName==="SELECT"?"select":t.tagName==="TEXTAREA"?"textarea":t.type||"text",u=o(t);if(!u)continue;const d={id:l,type:s,label:u},p=t.placeholder;p&&p!==u&&(d.placeholder=p);const m=t.getAttribute("name");if(m&&m!==l&&(d.name=m),t.tagName==="SELECT"){const c=Array.from(t.options).map(f=>f.text.trim()).filter(f=>f&&f.toLowerCase()!=="select");c.length&&(d.options=c.slice(0,10))}t.required&&(d.required=!0),i.push(d),a+=JSON.stringify(d).length}return{url:window.location.href,title:document.title,fields:i,totalFields:n.length}}function M(){}globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function g(e,...o){}const C={debug:(...e)=>g(console.debug,...e),log:(...e)=>g(console.log,...e),warn:(...e)=>g(console.warn,...e),error:(...e)=>g(console.error,...e)};let h;try{h=O.main(),h instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw C.error("The background crashed on startup!"),e}var U=h;return U})();
