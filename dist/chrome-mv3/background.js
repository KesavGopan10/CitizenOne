var background=(function(){"use strict";function x(e){return e==null||typeof e=="function"?{main:e}:e}const g="citizen_one_settings",v={activeProvider:"gemini",providers:{gemini:{key:"gemini",model:"gemini-1.5-flash",enabled:!0},groq:{key:"groq",model:"llama3-8b-8192",enabled:!1},nvidia:{key:"nvidia",baseUrl:"https://integrate.api.nvidia.com/v1",model:"meta/llama-3.1-70b-instruct",enabled:!1},ollama:{key:"ollama",baseUrl:"http://localhost:11434/v1",model:"llama3",enabled:!1}},vaultExists:!1,autoFill:!1,highlightFields:!0};async function w(){return new Promise(e=>{chrome.storage.local.get([g],o=>{o[g]?e({...v,...o[g]}):e(v)})})}function _(e){return`You are CitizenOne, a privacy-first form assistant.
Your task is to analyze a web form and map each form field to the correct data key.

Available data keys from the user's local vault:
${e.map(o=>`  - ${o}`).join(`
`)}

Rules:
1. Respond ONLY with a valid JSON object mapping field IDs to vault keys.
2. Only include fields you can confidently map. Skip fields you are unsure about.
3. Do NOT invent or hallucinate keys not in the vault list above.
4. Format: { "field_id_or_name": "vault_key" }
5. Example: { "first-name": "first_name", "dob": "date_of_birth" }

Output ONLY the JSON object. No explanation, no markdown fences.`}function T(e){const o=e.fields.map(r=>{const n=[`id="${r.id}"`,`type="${r.type}"`,`label="${r.label}"`];return r.placeholder&&n.push(`placeholder="${r.placeholder}"`),r.name&&n.push(`name="${r.name}"`),r.options?.length&&n.push(`options=[${r.options.slice(0,8).join(", ")}]`),r.required&&n.push("required"),r.context&&n.push(`context="${r.context.slice(0,80)}"`),`  { ${n.join(", ")} }`}).join(`,
`);return`Form URL: ${e.url}
Form Title: ${e.title}
Fields:
[
${o}
]

Map these fields to vault keys.`}async function E(e,o,r,n){const i=`https://generativelanguage.googleapis.com/v1beta/models/${o}:generateContent?key=${e}`,a=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({system_instruction:{parts:[{text:r}]},contents:[{parts:[{text:n}],role:"user"}],generationConfig:{temperature:.1,maxOutputTokens:1024,responseMimeType:"application/json"}})});if(!a.ok){const l=await a.text();throw new Error(`Gemini error ${a.status}: ${l}`)}return((await a.json())?.candidates?.[0]?.content?.parts?.[0]?.text??"").trim()}async function S(e,o,r,n,i){const a=`${e}/chat/completions`,t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:r,messages:[{role:"system",content:n},{role:"user",content:i}],temperature:.1,max_tokens:1024,response_format:{type:"json_object"}})});if(!t.ok){const c=await t.text();throw new Error(`API error ${t.status}: ${c}`)}return((await t.json())?.choices?.[0]?.message?.content??"").trim()}const O={gemini:{baseUrl:"https://generativelanguage.googleapis.com",model:"gemini-1.5-flash"},groq:{baseUrl:"https://api.groq.com/openai/v1",model:"llama3-8b-8192"},nvidia:{baseUrl:"https://integrate.api.nvidia.com/v1",model:"meta/llama-3.1-70b-instruct"},ollama:{baseUrl:"http://localhost:11434/v1",model:"llama3"}};async function h(e,o,r){const n=O[e.key],i=e.model??n.model,a=e.baseUrl??n.baseUrl,t=_(r),s=T(o);let l;if(e.key==="gemini"){if(!e.apiKey)throw new Error("Gemini API key is required.");l=await E(e.apiKey,i,t,s)}else{if(e.key!=="ollama"&&!e.apiKey)throw new Error(`${e.key} API key is required.`);l=await S(a,e.apiKey??"ollama",i,t,s)}let c;try{const m=l.replace(/```json\n?|```\n?/g,"").trim();c=JSON.parse(m)}catch{throw new Error(`Failed to parse LLM response as JSON. Raw: ${l}`)}const d=new Set(r),p={};for(const[m,u]of Object.entries(c))d.has(u)&&(p[m]=u);return p}async function P(e,o,r,n){if(e.key!=="gemini")throw new Error("Document extraction currently only supported via Gemini 1.5 Flash.");const i=`You are CitizenOne, a document processing assistant.
Extract information from this document that matches the following labels:
${n.join(", ")}

Rules:
1. Return ONLY a JSON object mapping labels to extracted values.
2. If a label is not found, do not include it.
3. If multiple values exist (e.g. multiple addresses), pick the primary/permanent one.
4. Format: { "first_name": "John", "postal_code": "12345" }`,a=e.apiKey;if(!a)throw new Error("Gemini API key is required.");const t=`https://generativelanguage.googleapis.com/v1beta/models/${e.model??"gemini-1.5-flash"}:generateContent?key=${a}`,s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:i},{inline_data:{mime_type:r,data:o}}]}],generationConfig:{temperature:.1,responseMimeType:"application/json"}})});if(!s.ok){const d=await s.text();throw new Error(`Extraction failed: ${d}`)}const c=(await s.json())?.candidates?.[0]?.content?.parts?.[0]?.text??"{}";try{return JSON.parse(c)}catch{throw new Error(`Failed to parse extraction result: ${c}`)}}async function $(e){return await h(e,{url:"https://test.example",title:"Test Form",fields:[{id:"first_name_field",type:"text",label:"First Name",required:!0}]},["first_name","last_name","email"]),"Connection successful!"}const k=Object.freeze(Object.defineProperty({__proto__:null,analyzeForm:h,extractFromDocument:P,testProvider:$},Symbol.toStringTag,{value:"Module"})),A=x(()=>{console.log("[CitizenOne] Background service worker started."),chrome.action.onClicked.addListener(async e=>{e.id&&chrome.tabs.sendMessage(e.id,{type:"TRIGGER_AUTOFILL"})}),chrome.runtime.onMessage.addListener((e,o,r)=>(N(e,o,r),!0))});async function N(e,o,r){try{switch(e.type){case"ANALYZE_FORM":{const n=e.semanticMap,i=e.vaultKeys,a=await w(),t=a.providers[a.activeProvider],s={key:a.activeProvider,apiKey:t.apiKey,baseUrl:t.baseUrl,model:t.model},l=await h(s,n,i);r({success:!0,data:l});break}case"INJECT_AND_GET_MAP":{const n=o.tab?.id??e.tabId;if(!n){r({success:!1,error:"No tab ID provided."});return}const a=(await chrome.scripting.executeScript({target:{tabId:n},func:C}))?.[0]?.result;if(!a){r({success:!1,error:"Failed to extract semantic map."});return}r({success:!0,data:a});break}case"TEST_PROVIDER":{const{providerKey:n,apiKey:i,baseUrl:a,model:t}=e,{testProvider:s}=await Promise.resolve().then(()=>k),l=await s({key:n,apiKey:i,baseUrl:a,model:t});r({success:!0,data:l});break}case"EXTRACT_DOCUMENT":{const{fileBase64:n,fileType:i,vaultKeys:a}=e,t=await w(),s=t.providers[t.activeProvider],{extractFromDocument:l}=await Promise.resolve().then(()=>k),c=await l({key:t.activeProvider,apiKey:s.apiKey,baseUrl:s.baseUrl,model:s.model},n,i,a);r({success:!0,data:c});break}default:r({success:!1,error:`Unknown message type: ${e.type}`})}}catch(n){const i=n instanceof Error?n.message:String(n);console.error("[CitizenOne] Background error:",i),r({success:!1,error:i})}}function C(){function o(t){const s=t.getAttribute("aria-label");if(s)return s.trim();const l=t.getAttribute("aria-labelledby");if(l){const u=document.getElementById(l);if(u)return(u.textContent??"").trim()}const c=t.id;if(c){const u=document.querySelector(`label[for="${CSS.escape(c)}"]`);if(u)return(u.textContent??"").trim()}const d=t.closest("label");if(d){const u=d.cloneNode(!0);u.querySelectorAll("input,select,textarea").forEach(U=>U.remove());const f=(u.textContent??"").trim();if(f)return f}const p=t.placeholder;if(p)return p.trim();const m=t.getAttribute("name");return m?m.replace(/[_-]/g," ").trim():""}const n=Array.from(document.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="reset"]):not([type="image"]), select, textarea')),i=[];let a=0;for(const t of n){if(!t.offsetParent)continue;if(a>=2048)break;const s=t.id||t.getAttribute("name")||`field_${i.length}`,l=t.tagName==="SELECT"?"select":t.tagName==="TEXTAREA"?"textarea":t.type||"text",c=o(t);if(!c)continue;const d={id:s,type:l,label:c},p=t.placeholder;p&&p!==c&&(d.placeholder=p);const m=t.getAttribute("name");if(m&&m!==s&&(d.name=m),t.tagName==="SELECT"){const u=Array.from(t.options).map(f=>f.text.trim()).filter(f=>f&&f.toLowerCase()!=="select");u.length&&(d.options=u.slice(0,10))}t.required&&(d.required=!0),i.push(d),a+=JSON.stringify(d).length}return{url:window.location.href,title:document.title,fields:i,totalFields:n.length}}function I(){}globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function y(e,...o){}const j={debug:(...e)=>y(console.debug,...e),log:(...e)=>y(console.log,...e),warn:(...e)=>y(console.warn,...e),error:(...e)=>y(console.error,...e)};let b;try{b=A.main(),b instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw j.error("The background crashed on startup!"),e}var F=b;return F})();
